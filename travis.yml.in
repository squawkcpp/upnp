sudo: required
language: cpp
services:
  - docker
env:
  global:
    - secure: "Ts1tH2JoTMGNkz/ozcNWElF16+UhN+b32TEcCy+Ip5ik4x3pgX5BBUA+SrCeAucBmHvQmohiHweEDHhL/UMaVgaCceO74yKLMIaxy7izdqvOgq9CqweIzmBcgir7xAMGEivNqFmOB2rXkyStSzYcvKQ/hKRoREjimteItvb8hWwQEMbr2bQQbdmPINKUkXoZuWEUytvhJR/DrYSkVgcgJs0Wcga2jWS14ILPMfDurl5onOYdxEbYC8lMiR1w14chx3VPVd+szzaHiVxWb2dIL+2SfKR+4A3atZ+OrjhGBCoPE0kkWYkkQmZRKP7qRlMOjnPYLl8i/VYhSVe9b7ZaiMTLmKWPeuw2IOnZ/06GhL3MotGnGV4xLLc/Aq/Wk1NuIYbhmXf/HbuWyssRBfsLbw37Vofgk4n+6hWrscgpPS4WeVWz4YsWjGVoGj9Rii9UfzHAhc9dmenjq3BcWo+dE8qFQ2OIrirHpt4toaFRQmQAkD1k3siVrzOT5SBKIZi6OowBdz/NI9rKkSwevhY09TOghhrQXt2wfVhxsBcBWmvWD16iK0boEwHmesswxRrIuQ6IIug5PmFLULzYlqV2MiIw8n2DSyjJv5XiK4csrsl+a9yMzgDCGFi7P108gwm3efG8gnuBUkxE5AOxy0ezG3mW0ZOVCJ6i8kl2lbc3HH4=" # DOCKER_USER
    - secure: "Ks1M9Lkg6TOuY97dGvRycVSZV5PBzQC7lY3BHzbXswEkO/NrzwOfIf/Z8Ut/1+K/gpLIMkaKAEoIAgNrsIv4vjVA4tcUbhcNNbx9EnJlnO8kJkZBuJrazObKEII7Eay8Ay3g0plRUbTueizwwMRcmpggJAconpSTsRAIt3ayCCrLzJnrRZeey35IJkOWELMGRV+Ra6WpJ3zDeoVDhpTuB/Az46sFQ8yJdEqYsrFxtq5zui4cA2zMpLaJFdod9xdXUSeM5SNNMP3R382xXh2saOondOeh7z6dXPZBz4U23rirqVGd48HKaWCNJjQZp54Y9c9HjzcLOP8/mHGI93rFNavdEkes7G7LDBLdn+C4id33IpHH47tjnU7E1Y+ChQtpcd6MHQRMCCOHkwDFFdC/0EmRSF8q9+oV051WT1/qZEaW246NT7Bq6ID5KMX4oCDjM+1bC1Enx+FPxX+NOQCzzw5F/n4QwO4DdB717DfgOzYbULhD/NYSQtx1CfyUdmdw0uR/bkmd5t6Krb1pSIL1jodVSvwLPgBjVypPfhHSSmNwYEWEwYl3fSNBhITn4La6P7NBIc2BRzw9iE25rOZgTKBEzbzxWOGF4fbMhd+gxA0N25rxF/yvDCb8F9KoKxwUa5DJO3SGZZ0IzevwEOj5D+cr6pSxiEreRq0EiRjIOyo=" # DOCKER_PASS
    - COMMIT=${TRAVIS_COMMIT::8}
before_install:
  - mkdir $(pwd)/build
  - docker pull spielhuus/buildimage:latest
  - sudo docker run -itd --name build -v $(pwd)/upnp:/repo -v $(pwd)/build:/build spielhuus/buildimage
  - sudo docker exec build apt-get -y update
  - sudo docker exec build apt-get -y install libsdl2-dev libboost-all-dev libao-dev libimlib2-dev libsqlite3-dev libxml++-dev libpcre++-dev libxml2-dev libmp3lame-dev libflac++-dev libpoppler-cpp-dev libcurl4-openssl-dev libcurlpp-dev libzmq-dev libsigc++-2.0-dev libssl-dev libarchive-dev uuid-dev libhiredis-dev libev-dev libmagic-dev libopencv-dev libmusicbrainz5-dev libavcodec-dev libavdevice-dev libavfilter-dev libavformat-dev libavresample-dev libavcodec-extra
  - sudo docker exec build git clone https://github.com/squawkcpp/upnp.git /repo
script:
  - sudo docker exec build cmake -H/repo -B/build
  - sudo docker exec build cmake --build /build
  - sudo docker exec build /build/test_upnp
  - sudo docker exec build cmake --build /build --target package

deploy:
  provider: releases
  api_key:
    secure: "PkcR+VgR0PzvGC+hc3SJPvUPjpV1juZAzMYOGi+Ez9Rgwuf06a5RAOHPnWwJ230ocEqGV6HQW/scufSZpahTpvB4e28nzoJSBcdmjWhNmy3NzENeseu6NgzhwJXtkfFYhMpoBTtT0E295CIvjY7PwvWG3oxhuzIfmMBHobKkGjJc8rQfGqhlzrYpja59luX4CqKVFasBRRGyeMaQ/zM6Ng9AKz23XwBUF7esyqwjPxbqFwrAgnn1ZL/PosCb2yb8GVuRl5/J0mSfLUxAeJ+T5z9Z4FLyeSWdzrKvNwFiOrPUAR/rC0hFqgYJOO7Bgf6wmF9uCLv6pfc/l/l9Y3FgERfDn8P3ijoixv9cQm8LkL2H1ysf0e+l/d0MlahZ2YMr5rZWKk29jZdBto7ceA0USXh4Ql+lsJHci4Yt9wm5RAZXn1fJKRMeahKIxwCuAIpDMGeTWnSmc42Y3meoAtIZNi8O481FGSo6n6xSOccMxqhnjZE+NGjvPOFSBZgy4Da0WnHZoSALFfDQGvExVEVPYTurltTlLNUUsPQk1W6qFPEMpDNZ0x77lIx0uhEWgj8gaIlHt00KhEAyUIWOAQm9WIqipyy/MmXN9SwdaQdwIxWBadGh4hft1zx6cBoyuBv51Bz5bdbldoKicrExMYqWmGveJdCzTFDCqmg3gC+HpEs="
  file: '$(pwd)/build/upnp_@UPNP_TAG_VERSION@.deb'
  skip_cleanup: true
  on:
    tags: true
    all_branches: true
    repo: squawkcpp/upnp

after_success:
  - sudo docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export REPO=squawkcpp/upnp
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - sudo docker build -f Dockerfile -t $REPO:$COMMIT .
  - sudo docker tag $REPO:$COMMIT $REPO:$TAG
  - sudo docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - sudo docker push $REPO

